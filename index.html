<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gemini Chat Ultra Premium</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ---------------------------------- Global Styles ---------------------------------- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primary-color: #075E54; /* WhatsApp Green Dark */
      --secondary-color: #128C7E; /* WhatsApp Green Light */
      --whatsapp-bg: #ECE5DD; /* WhatsApp Chat Background */
      --whatsapp-bubble-received: #FFFFFF;
      --whatsapp-bubble-sent: #DCF8C6;
      --text-dark: #333;
      --text-light: #fff;
      --bg-light: rgba(255, 255, 255, 0.98);
      --border-light: #e0e0e0;
      --shadow-light: rgba(0, 0, 0, 0.15);
      --shadow-heavy: rgba(0, 0, 0, 0.35);
      --input-bg: #f7f7f7;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #007bff;
      --gemini-color: #4CAF50;
      --admin-badge: #00BFFF; /* Deep sky blue for admin checkmark */
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(-45deg, #075E54, #128C7E, #34B7F1, #25D366); /* WhatsApp-like gradient */
      background-size: 400% 400%;
      animation: gradientBG 25s ease infinite;
      color: var(--text-dark);
      height: 100vh;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background-color 0.5s ease;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* ---------------------------------- Card & Form Styling ---------------------------------- */
    .card {
      background: var(--bg-light);
      border-radius: 30px;
      padding: 45px;
      box-shadow: 0 25px 60px var(--shadow-heavy);
      max-width: 550px;
      width: 90%;
      margin: auto;
      backdrop-filter: blur(15px);
      transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      transform: scale(0.9) translateY(20px);
      opacity: 0;
      animation: fadeInZoomIn 0.8s forwards ease-out;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    @keyframes fadeInZoomIn {
      to {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    .card h2 {
      text-align: center;
      margin-bottom: 35px;
      color: var(--text-dark);
      font-weight: 800;
      font-size: 2.5em;
      letter-spacing: 1.5px;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    input[type="text"],
    input[type="password"],
    input[type="email"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 20px 25px;
      margin: 18px 0;
      font-size: 1.15em;
      border-radius: 15px;
      border: 1px solid var(--border-light);
      background-color: var(--input-bg);
      transition: all 0.4s ease;
      box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.08);
      font-family: 'Montserrat', sans-serif;
      resize: vertical;
      min-height: 60px; /* For textarea */
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="email"]:focus,
    input[type="number"]:focus,
    textarea:focus {
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 5px rgba(37, 117, 252, 0.3);
      outline: none;
      background-color: var(--text-light);
    }

    button {
      width: 100%;
      padding: 20px;
      margin-top: 30px;
      font-size: 1.3em;
      border-radius: 15px;
      border: none;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: var(--text-light);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      overflow: hidden;
      z-index: 1;
      box-shadow: 0 10px 25px var(--shadow-light);
    }

    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 200%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      z-index: -1;
      transition: transform 0.6s ease;
      transform: skewX(-20deg);
    }

    button:hover::before {
      transform: skewX(-20deg) translateX(120%);
    }

    button:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 15px 35px var(--shadow-heavy);
      background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
    }

    .link {
      color: var(--primary-color);
      cursor: pointer;
      text-align: center;
      margin-top: 25px;
      display: block;
      font-size: 1.05em;
      transition: color 0.3s ease, text-decoration 0.3s ease;
      font-weight: 500;
    }

    .link:hover {
      color: var(--secondary-color);
      text-decoration: underline;
    }

    .message {
      color: var(--danger-color);
      text-align: center;
      margin-top: 20px;
      font-weight: 600;
      font-size: 1.05em;
    }

    /* ---------------------------------- Chat Container ---------------------------------- */
    #chat-container {
      display: none;
      flex-direction: row;
      height: 95vh;
      width: 98vw;
      max-width: 1600px;
      background: var(--bg-light);
      border-radius: 30px;
      box-shadow: 0 25px 70px var(--shadow-heavy);
      overflow: hidden;
      animation: slideInFromTop 0.8s forwards cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    @keyframes slideInFromTop {
      from {
        transform: translateY(-50px) scale(0.95);
        opacity: 0;
      }
      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    /* ---------------------------------- User List ---------------------------------- */
    #user-list {
      width: 350px;
      background: #f0f2f5; /* WhatsApp-like sidebar */
      padding: 30px;
      overflow-y: auto;
      border-right: 2px solid var(--border-light);
      display: flex;
      flex-direction: column;
      position: relative;
      transition: width 0.3s ease;
      flex-shrink: 0;
    }

    #user-list h3 {
      font-size: 2.1em;
      color: var(--primary-color);
      margin-bottom: 30px;
      font-weight: 800;
      position: sticky;
      top: 0;
      background: #f0f2f5;
      padding-bottom: 15px;
      z-index: 10;
      border-bottom: 2px solid var(--border-light);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    #user-list h3 i {
        color: var(--secondary-color);
    }


    #user-list ul {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
    }

    #user-list ul li {
      background: var(--text-light);
      margin-bottom: 18px;
      padding: 18px 25px;
      border-radius: 20px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      display: flex;
      align-items: center;
      font-size: 1.1em;
      font-weight: 600;
      color: #555;
      position: relative;
      overflow: hidden;
    }

    #user-list ul li:hover {
      background: #e9f0f7; /* Lighter hover for WhatsApp feel */
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      border: 1px solid var(--secondary-color);
    }

    #user-list ul li.active {
      background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
      color: var(--text-light);
      box-shadow: 0 8px 20px var(--shadow-light);
      transform: translateY(-3px) scale(1.01);
    }

    #user-list .user-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background-color: #ccc;
      margin-right: 15px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-light);
      font-weight: 700;
      font-size: 1.2em;
      flex-shrink: 0;
      border: 3px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      background: linear-gradient(45deg, #8BC34A, #CDDC39); /* Greenish-yellow avatars */
    }

    #user-list ul li.active .user-avatar {
      background: var(--text-light);
      color: var(--primary-color);
    }

    #user-list ul li .user-info {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
    }
    #user-list ul li .user-name {
        font-weight: 700;
        font-size: 1.1em;
        display: flex;
        align-items: center;
    }
    #user-list ul li .user-name .admin-badge {
        color: var(--admin-badge);
        font-size: 0.9em;
        margin-left: 8px;
        filter: drop-shadow(0 1px 1px rgba(0,0,0,0.2));
    }
    #user-list ul li .user-username {
        font-size: 0.85em;
        color: #777;
        margin-top: 2px;
        font-weight: 500;
    }
    #user-list ul li.active .user-username {
        color: rgba(255, 255, 255, 0.8);
    }
    
    #user-list .gemini-ai-link {
      background: linear-gradient(90deg, var(--gemini-color), #66BB6A);
      color: var(--text-light);
      font-weight: 700;
      margin-top: 25px;
      padding: 20px 25px;
      border-radius: 20px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      font-size: 1.15em;
      position: relative;
      overflow: hidden;
    }

    #user-list .gemini-ai-link:hover {
      background: linear-gradient(90deg, #66BB6A, var(--gemini-color));
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    #user-list .gemini-ai-link i {
      margin-right: 12px;
      font-size: 1.4em;
    }

    #user-list hr {
      border: none;
      border-top: 1px dashed var(--border-light);
      margin: 30px 0;
    }

    /* ---------------------------------- Chat Box ---------------------------------- */
    #chat-box {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--whatsapp-bg); /* WhatsApp chat background */
      position: relative;
    }

    #chat-header {
      background: var(--primary-color); /* WhatsApp Green Dark */
      color: var(--text-light);
      padding: 20px 30px;
      font-weight: bold;
      font-size: 1.8em;
      text-align: left;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      flex-shrink: 0;
    }

    #chat-header .chat-partner-info {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        margin-left: 15px;
    }

    #chat-header .chat-partner-name {
        font-size: 1.2em;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #chat-header .chat-partner-status {
        font-size: 0.8em;
        font-weight: 400;
        opacity: 0.9;
    }
    #chat-header .chat-partner-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        color: var(--primary-color);
        font-weight: 700;
        font-size: 1.3em;
        flex-shrink: 0;
        border: 2px solid rgba(255, 255, 255, 0.5);
    }


    #chat-header .chat-options {
      display: flex;
      gap: 10px; /* Reduced gap */
      margin-left: auto; /* Push to right */
    }

    #chat-header .chat-options button {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 1.4em;
      padding: 8px;
      border-radius: 50%;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: none;
      margin: 0;
      width: 45px; /* Fixed size for circular buttons */
      height: 45px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }

    #chat-header .chat-options button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }
    #chat-header .admin-badge {
        color: var(--admin-badge);
        font-size: 1em;
        filter: drop-shadow(0 1px 1px rgba(0,0,0,0.2));
    }


    #chat-messages {
      flex: 1;
      padding: 25px 30px;
      overflow-y: auto;
      background: var(--whatsapp-bg);
      display: flex;
      flex-direction: column;
      gap: 8px; /* Reduced gap for more compact WA-like messages */
      scroll-behavior: smooth;
      background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); /* WA chat background pattern */
      background-size: contain;
      background-repeat: repeat;
    }
    #chat-messages::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 50px; /* Gradient fade at top */
        background: linear-gradient(to bottom, rgba(236,229,221,1), rgba(236,229,221,0));
        z-index: 5;
        pointer-events: none;
    }
    #chat-messages::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 50px; /* Gradient fade at bottom */
        background: linear-gradient(to top, rgba(236,229,221,1), rgba(236,229,221,0));
        z-index: 5;
        pointer-events: none;
    }


    /* ---------------------------------- Message Bubbles ---------------------------------- */
    .msg-bubble {
      margin: 0;
      padding: 9px 12px;
      max-width: 75%; /* Increased max width */
      border-radius: 8px; /* WA-like sharp corners */
      word-wrap: break-word;
      font-size: 0.95em;
      line-height: 1.3;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13); /* Softer shadow */
      position: relative;
      animation: fadeInMessage 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
      transform-origin: bottom;
    }

    @keyframes fadeInMessage {
      from { opacity: 0; transform: translateY(8px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .msg-user {
      background: var(--whatsapp-bubble-sent);
      color: var(--text-dark);
      align-self: flex-end;
      text-align: right;
      border-bottom-right-radius: 0; /* Sharp corner for WA */
      margin-left: auto; /* Push to right */
    }

    .msg-bot {
      background: var(--whatsapp-bubble-received);
      color: var(--text-dark);
      align-self: flex-start;
      border-bottom-left-radius: 0; /* Sharp corner for WA */
      margin-right: auto; /* Push to left */
    }

    /* WhatsApp-like message tails */
    .msg-user::after {
      content: '';
      position: absolute;
      top: 0; /* Changed from bottom to top for WA-like tail */
      right: -8px;
      width: 12px;
      height: 19px;
      background: var(--whatsapp-bubble-sent);
      border-bottom-left-radius: 100%;
      border-top-right-radius: 0;
      border-top-left-radius: 100%; /* For curve */
      transform: rotate(20deg) skewX(20deg); /* Adjust for tail shape */
      z-index: -1;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13); /* Shadow on tail */
    }

    .msg-bot::after {
      content: '';
      position: absolute;
      top: 0; /* Changed from bottom to top for WA-like tail */
      left: -8px;
      width: 12px;
      height: 19px;
      background: var(--whatsapp-bubble-received);
      border-bottom-right-radius: 100%;
      border-top-left-radius: 0;
      border-top-right-radius: 100%; /* For curve */
      transform: rotate(-20deg) skewX(-20deg); /* Adjust for tail shape */
      z-index: -1;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13); /* Shadow on tail */
    }

    .msg-bubble img,
    .msg-bubble audio,
    .msg-bubble video {
      max-width: 100%;
      border-radius: 8px;
      display: block;
      margin-top: 5px; /* Reduced margin */
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .msg-timestamp {
      font-size: 0.7em; /* Smaller timestamp */
      color: #888; /* Darker for readability */
      margin-top: 4px; /* Reduced margin */
      display: block;
      opacity: 0.9;
    }
    .msg-user .msg-timestamp {
      color: #666; /* Darker for sent bubble */
    }

    /* ---------------------------------- Chat Input ---------------------------------- */
    #chat-input {
      display: flex;
      padding: 10px 15px; /* Reduced padding */
      background: #f0f2f5; /* WhatsApp input background */
      border-top: 1px solid var(--border-light);
      box-shadow: 0 -3px 10px rgba(0, 0, 0, 0.05);
      align-items: center;
      gap: 8px; /* Reduced gap */
      flex-shrink: 0;
    }

    #chat-input input[type="text"] {
      flex: 1;
      padding: 12px 18px; /* Reduced padding */
      border-radius: 25px; /* WA-like input shape */
      border: 1px solid #ccc;
      font-size: 1em;
      background-color: var(--text-light);
      transition: all 0.3s ease;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08);
      font-family: 'Montserrat', sans-serif;
    }

    #chat-input input[type="text"]:focus {
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(37, 117, 252, 0.2);
      outline: none;
    }

    #chat-input input[type="file"] {
      display: none;
    }

    #chat-input button {
      padding: 0;
      border-radius: 50%;
      font-size: 1.2em;
      margin: 0;
      width: 48px; /* Fixed size for circle buttons */
      height: 48px;
      background: var(--primary-color);
      color: var(--text-light);
      border: none;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-shrink: 0;
    }

    #chat-input button:hover {
      transform: scale(1.05) rotate(5deg);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      background: var(--secondary-color);
    }

    #chat-input button.send-button {
        background: var(--secondary-color);
    }
    #chat-input button.send-button:hover {
        background: var(--primary-color);
    }

    /* ---------------------------------- Controls Panel ---------------------------------- */
    .controls-panel {
      margin-top: 30px;
      padding: 25px;
      background: var(--text-light);
      border-radius: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      border: 1px solid var(--border-light);
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .controls-panel h4 {
      font-size: 1.4em;
      margin-bottom: 15px;
      color: var(--primary-color);
      border-bottom: 2px solid var(--border-light);
      padding-bottom: 10px;
      font-weight: 700;
    }

    .controls-panel button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 15px;
      border-radius: 15px;
      font-size: 1.05em;
      margin: 0; /* Override default button margin */
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .controls-panel button i {
      margin-right: 10px;
      font-size: 1.1em;
    }

    .controls-panel button.danger { background: var(--danger-color); }
    .controls-panel button.success { background: var(--success-color); }
    .controls-panel button.warning { background: var(--warning-color); }
    .controls-panel button.info { background: var(--info-color); }
    .controls-panel button.default { background: #6c757d; } /* Grey for general actions */


    .controls-panel button:hover {
      transform: translateY(-3px) scale(1.01);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      filter: brightness(1.1);
    }

    .stats {
      font-size: 0.95em;
      background: #f0f8ff;
      padding: 15px;
      margin-top: 20px;
      border-radius: 12px;
      border: 1px solid #d9e6f2;
      color: #444;
      line-height: 1.7;
      box-shadow: inset 0 1px 4px rgba(0,0,0,0.08);
    }

    /* ---------------------------------- Modal Styles ---------------------------------- */
    #modal-backdrop {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    #modal-backdrop.show {
      opacity: 1;
      pointer-events: all;
    }

    #modal-content {
      background: var(--text-light);
      border-radius: 25px;
      padding: 35px;
      box-shadow: 0 15px 40px var(--shadow-heavy);
      max-width: 450px;
      width: 90%;
      transform: scale(0.9);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    #modal-backdrop.show #modal-content {
      transform: scale(1);
      opacity: 1;
    }

    #modal-title {
      margin-bottom: 25px;
      text-align: center;
      color: var(--primary-color);
      font-weight: 700;
      font-size: 1.8em;
    }

    #modal-body p {
      margin-bottom: 15px;
      line-height: 1.6;
      color: #555;
    }

    #modal-body input, #modal-body textarea {
      margin-bottom: 10px;
    }

    #modal-body select {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 10px;
      border: 1px solid var(--border-light);
      background-color: var(--input-bg);
      font-size: 1em;
    }

    #modal-actions {
      margin-top: 30px;
      display: flex;
      justify-content: flex-end;
      gap: 15px;
    }

    #modal-actions button {
      width: auto;
      padding: 12px 25px;
      font-size: 1.05em;
      margin: 0;
      border-radius: 12px;
      box-shadow: none;
    }

    #modal-actions button.cancel-btn { background: #6c757d; }
    #modal-actions button.confirm-btn { background: var(--secondary-color); }
    #modal-actions button.confirm-btn:hover { background: var(--primary-color); }

    /* ---------------------------------- Responsive Design ---------------------------------- */
    @media (max-width: 992px) {
      #user-list {
        width: 300px;
      }
      #chat-header {
        font-size: 1.6em;
        padding: 15px 25px;
      }
      #chat-header .chat-options button {
        font-size: 1.2em;
        width: 40px;
        height: 40px;
      }
      #chat-input input[type="text"] {
        padding: 10px 15px;
        font-size: 0.95em;
      }
      #chat-input button {
        width: 45px;
        height: 45px;
        font-size: 1.1em;
      }
      .msg-bubble {
        padding: 8px 10px;
        font-size: 0.9em;
      }
    }

    @media (max-width: 768px) {
      body {
        align-items: flex-start;
        padding-top: 10px;
      }
      .card {
        padding: 30px;
        margin: 10px auto;
        width: 95%;
        border-radius: 20px;
      }
      .card h2 {
        font-size: 1.8em;
        margin-bottom: 20px;
      }
      input[type="text"], input[type="password"], textarea {
        padding: 14px 18px;
        margin: 10px 0;
        font-size: 0.95em;
        border-radius: 10px;
      }
      button {
        padding: 14px;
        font-size: 1.1em;
        border-radius: 10px;
        margin-top: 15px;
      }

      #chat-container {
        flex-direction: column;
        height: 98vh;
        width: 98vw;
        border-radius: 15px;
      }
      #user-list {
        width: 100%;
        height: 250px; /* Fixed height for user list on small screens */
        border-right: none;
        border-bottom: 2px solid var(--border-light);
        padding: 15px;
      }
      #user-list h3 {
        font-size: 1.5em;
        margin-bottom: 15px;
      }
      #user-list ul li {
        padding: 12px 18px;
        margin-bottom: 10px;
        font-size: 0.95em;
        border-radius: 12px;
      }
      #user-list .user-avatar {
          width: 40px;
          height: 40px;
          font-size: 1em;
          margin-right: 12px;
      }
      #user-list .gemini-ai-link {
        padding: 15px 20px;
        font-size: 1em;
        margin-top: 15px;
        border-radius: 15px;
      }

      #chat-box {
        flex: 1;
      }
      #chat-header {
        font-size: 1.4em;
        padding: 12px 20px;
      }
      #chat-header .chat-partner-avatar {
          width: 45px;
          height: 45px;
          font-size: 1.2em;
      }
      #chat-header .chat-partner-name {
          font-size: 1.1em;
      }
      #chat-header .chat-partner-status {
          font-size: 0.75em;
      }
      #chat-header .chat-options button {
        font-size: 1.1em;
        width: 38px;
        height: 38px;
      }
      #chat-messages {
        padding: 10px 15px;
        gap: 6px;
      }
      .msg-bubble {
        max-width: 90%;
        padding: 8px 10px;
        font-size: 0.85em;
        border-radius: 8px;
      }
      .msg-user::after, .msg-bot::after {
        width: 10px;
        height: 16px;
        right: -6px;
        left: -6px;
      }
      #chat-input {
        flex-wrap: wrap;
        padding: 8px 12px;
        gap: 6px;
      }
      #chat-input input[type="text"] {
        flex-basis: 100%;
        margin-bottom: 5px;
        padding: 10px 15px;
        border-radius: 20px;
      }
      #chat-input button {
        width: 40px;
        height: 40px;
        font-size: 1em;
        padding: 0;
      }
      #modal-content {
        padding: 25px;
        border-radius: 20px;
      }
      #modal-title {
        font-size: 1.5em;
        margin-bottom: 20px;
      }
      #modal-actions button {
        padding: 10px 20px;
        font-size: 0.9em;
        border-radius: 10px;
      }
    }
    @media (max-width: 480px) {
      .card {
        padding: 20px;
      }
      .card h2 {
        font-size: 1.6em;
      }
      input[type="text"], input[type="password"], textarea {
        padding: 12px 15px;
      }
      button {
        padding: 12px;
        font-size: 1em;
      }
      #user-list h3 {
        font-size: 1.3em;
      }
      #user-list ul li, #user-list .gemini-ai-link {
        font-size: 0.9em;
        padding: 10px 12px;
      }
      #chat-header {
        font-size: 1.2em;
        padding: 10px 15px;
      }
      #chat-header .chat-partner-avatar {
          width: 40px;
          height: 40px;
          font-size: 1.1em;
      }
      #chat-header .chat-partner-name {
          font-size: 1em;
      }
      #chat-header .chat-partner-status {
          font-size: 0.7em;
      }
      #chat-input button {
        width: 36px;
        height: 36px;
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
  <div id="auth-section">
    <div class="login-form card" id="login-card">
      <h2>Masuk ke Gemini Chat</h2>
      <input id="login-username" type="text" placeholder="Username Anda">
      <input id="login-password" type="password" placeholder="Password Anda">
      <button onclick="login()">Login</button>
      <p class="link" onclick="toggleRegister(true)">Belum punya akun? Daftar sekarang</p>
      <p id="login-msg" class="message"></p>
    </div>
    <div class="register-form card" id="register-card" style="display:none">
      <h2>Buat Akun Baru</h2>
      <input id="reg-display-name" type="text" placeholder="Nama Panggilan/Tampilan Anda">
      <input id="reg-username" type="text" placeholder="Username (misal: @nama_Anda)">
      <input id="reg-password" type="password" placeholder="Password Kuat (min 6 karakter)">
      <textarea id="reg-bio" placeholder="Tulis bio singkat Anda (Opsional)"></textarea>
      <button onclick="register()">Daftar</button>
      <p class="link" onclick="toggleRegister(false)">Sudah punya akun? Login</p>
      <p id="reg-msg" class="message"></p>
    </div>
  </div>

  <div id="chat-container">
    <div id="user-list">
      <h3><i class="fas fa-comments"></i> Chat Pengguna</h3>
      <ul id="user-ul"></ul>
      <hr>
      <p class="gemini-ai-link" onclick="startChat('gemini')"><i class="fas fa-robot"></i> Chat dengan Gemini AI</p>

      <div class="controls-panel" id="admin-controls-panel" style="display:none;">
        <h4><i class="fas fa-user-shield"></i> Kontrol Admin</h4>
        <button class="info" onclick="showAllUserStats()"><i class="fas fa-chart-line"></i> Statistik Pengguna</button>
        <button class="warning" onclick="showBanUserModal()"><i class="fas fa-user-slash"></i> Kelola Ban Pengguna</button>
        <button class="danger" onclick="showDeleteUserModal()"><i class="fas fa-user-times"></i> Hapus Pengguna Permanen</button>
        <div id="admin-stats" class="stats"></div>
      </div>

      <div class="controls-panel" id="user-controls-panel" style="display:none;">
        <h4><i class="fas fa-user-cog"></i> Pengaturan Akun</h4>
        <button class="default" onclick="showEditProfileModal()"><i class="fas fa-user-edit"></i> Edit Profil & Bio</button>
        <button class="info" onclick="changePassword()"><i class="fas fa-key"></i> Ganti Password</button>
        <button class="danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>

    <div id="chat-box">
      <div id="chat-header">
        <div class="chat-partner-avatar" id="chat-partner-avatar"></div>
        <div class="chat-partner-info">
            <span class="chat-partner-name" id="chat-partner-name">Pilih Pengguna untuk Chat</span>
            <span class="chat-partner-status" id="chat-partner-status"></span>
        </div>
        <div class="chat-options">
          <button title="Panggilan Video (Simulasi)" onclick="showCallModal('video')"><i class="fas fa-video"></i></button>
          <button title="Panggilan Suara (Simulasi)" onclick="showCallModal('audio')"><i class="fas fa-phone"></i></button>
        </div>
      </div>
      <div id="chat-messages"></div>
      <div id="chat-input">
        <input id="msg-input" type="text" placeholder="Ketik pesan Anda..." onkeypress="handleKeyPress(event)">
        <input type="file" id="file-input" accept="image/*,audio/*,video/*">
        <button title="Lampirkan File" onclick="document.getElementById('file-input').click()"><i class="fas fa-paperclip"></i></button>
        <button title="Kirim Pesan" class="send-button" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <div id="modal-backdrop">
    <div id="modal-content">
      <h3 id="modal-title"></h3>
      <div id="modal-body"></div>
      <div id="modal-actions">
        <button class="cancel-btn" onclick="closeModal()">Batal</button>
        <button id="modal-confirm-btn" class="confirm-btn"></button>
      </div>
    </div>
  </div>

  <script>
    // Request Notification permission on page load
    Notification.requestPermission();

    // Initial user data. Annas is admin.
    let users = JSON.parse(localStorage.getItem('users')) || [
      { username: 'annas', password: 'annas', displayName: 'Admin Annas', bio: 'Saya adalah Administrator.', role: 'admin', banned: false, stats: { logins: 0, chatsSent: 0, chatsReceived: 0 } }
    ];
    let currentUser = null;
    let activeReceiver = null;
    let messages = JSON.parse(localStorage.getItem('messages')) || {}; // Store messages by sender-receiver pair

    // Function to get current timestamp formatted
    function getTimestamp() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    // --- Authentication Functions ---
    function toggleRegister(show) {
      document.getElementById('register-card').style.display = show ? 'block' : 'none';
      document.getElementById('login-card').style.display = show ? 'none' : 'block';
      document.getElementById('reg-msg').innerText = '';
      document.getElementById('login-msg').innerText = '';
      if (show) {
        document.getElementById('register-card').style.animation = 'fadeInZoomIn 0.8s forwards ease-out';
      } else {
        document.getElementById('login-card').style.animation = 'fadeInZoomIn 0.8s forwards ease-out';
      }
    }

    function register() {
      const displayName = document.getElementById('reg-display-name').value.trim();
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value.trim();
      const bio = document.getElementById('reg-bio').value.trim();

      if (!displayName || !username || !password) {
        return document.getElementById('reg-msg').innerText = '⚠️ Nama panggilan, username & password harus diisi.';
      }
      if (!username.startsWith('@')) {
        return document.getElementById('reg-msg').innerText = '⚠️ Username harus diawali dengan simbol "@" (contoh: @nama_Anda).';
      }
      if (password.length < 6) {
        return document.getElementById('reg-msg').innerText = '⚠️ Password minimal 6 karakter.';
      }
      if (users.find(u => u.username === username)) {
        return document.getElementById('reg-msg').innerText = '⚠️ Username sudah digunakan.';
      }

      users.push({ username, password, displayName, bio, role: 'user', banned: false, stats: { logins: 0, chatsSent: 0, chatsReceived: 0 } });
      localStorage.setItem('users', JSON.stringify(users));
      toggleRegister(false);
      alert('✅ Akun berhasil dibuat! Silakan login.');
      document.getElementById('reg-display-name').value = '';
      document.getElementById('reg-username').value = '';
      document.getElementById('reg-password').value = '';
      document.getElementById('reg-bio').value = '';
    }

    function login() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const user = users.find(u => u.username === username && u.password === password);

      if (!user) {
        return document.getElementById('login-msg').innerText = '⚠️ Username atau password salah. Mohon daftar jika belum punya akun.';
      }
      if (user.banned) {
        return document.getElementById('login-msg').innerText = '🚫 Akun Anda telah dibanned. Silakan hubungi admin.';
      }

      currentUser = user;
      currentUser.stats.logins++;
      localStorage.setItem('users', JSON.stringify(users));
      
      document.getElementById('auth-section').style.display = 'none';
      document.getElementById('chat-container').style.display = 'flex';
      
      updateChatHeader('Selamat Datang, ' + currentUser.displayName + (currentUser.role === 'admin' ? ' <i class="fas fa-check-circle admin-badge"></i>' : ''));
      document.getElementById('chat-partner-status').innerText = currentUser.bio || 'Status Anda';
      refreshUserList();
      
      if (currentUser.role === 'admin') {
        document.getElementById('admin-controls-panel').style.display = 'flex';
        showAdminStats();
      } else {
        document.getElementById('user-controls-panel').style.display = 'flex';
      }
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
    }

    function logout() {
      currentUser = null;
      activeReceiver = null;
      document.getElementById('auth-section').style.display = 'flex';
      document.getElementById('chat-container').style.display = 'none';
      document.getElementById('admin-controls-panel').style.display = 'none';
      document.getElementById('user-controls-panel').style.display = 'none';
      document.getElementById('login-msg').innerText = 'Anda telah berhasil logout.';
      // Reset chat display
      updateChatHeader('Pilih Pengguna untuk Chat');
      document.getElementById('chat-partner-status').innerText = '';
      document.getElementById('chat-partner-avatar').innerText = '';
      document.getElementById('chat-messages').innerHTML = '';
    }

    // --- User List and Chat Management ---
    function refreshUserList() {
      const ul = document.getElementById('user-ul');
      ul.innerHTML = '';
      
      // Include all users, but filter out current user for display
      const usersToDisplay = users.filter(u => u.username !== currentUser.username);

      usersToDisplay.forEach(u => {
        const li = document.createElement('li');
        li.setAttribute('data-username', u.username);
        li.onclick = () => startChat(u.username);
        
        const avatarInitial = u.displayName.charAt(0).toUpperCase();
        let userStatus = u.banned ? '<span style="color:red;">Dibanned</span>' : (u.online ? 'Online' : 'Offline'); // Placeholder for online status
        
        li.innerHTML = `
          <div class="user-avatar">${avatarInitial}</div>
          <div class="user-info">
            <span class="user-name">
                ${u.displayName}
                ${u.role === 'admin' ? '<i class="fas fa-check-circle admin-badge" title="Admin"></i>' : ''}
            </span>
            <span class="user-username">${u.username}</span>
          </div>
        `;
        ul.appendChild(li);
      });
      // Optionally re-select active chat if user list refreshes
      if (activeReceiver) {
        const activeLi = ul.querySelector(`li[data-username="${activeReceiver}"]`);
        if (activeLi) activeLi.classList.add('active');
      }
    }

    function startChat(username) {
      if (activeReceiver) {
        const prevActiveLi = document.querySelector(`#user-ul li.active`);
        if (prevActiveLi) prevActiveLi.classList.remove('active');
      }

      activeReceiver = username;
      document.getElementById('chat-messages').innerHTML = '';
      
      const targetUser = users.find(u => u.username === username);
      if (username === 'gemini') {
        updateChatHeader('Chat dengan Gemini AI');
        document.getElementById('chat-partner-avatar').innerHTML = '<i class="fas fa-robot"></i>';
        document.getElementById('chat-partner-status').innerText = 'Online';
      } else if (targetUser) {
        updateChatHeader(`Chat dengan ${targetUser.displayName} ${targetUser.role === 'admin' ? '<i class="fas fa-check-circle admin-badge" title="Admin"></i>' : ''}`);
        document.getElementById('chat-partner-avatar').innerText = targetUser.displayName.charAt(0).toUpperCase();
        document.getElementById('chat-partner-status').innerText = targetUser.bio || 'Online'; // Placeholder for online/offline
      }
      
      const currentActiveLi = document.querySelector(`#user-ul li[data-username="${username}"]`);
      if (currentActiveLi) currentActiveLi.classList.add('active');

      loadMessages();
    }

    function updateChatHeader(mainText) {
        document.getElementById('chat-partner-name').innerHTML = mainText;
        // Optionally update header avatar too
    }

    function saveMessages() {
      localStorage.setItem('messages', JSON.stringify(messages));
    }

    function loadMessages() {
      document.getElementById('chat-messages').innerHTML = '';
      const chatKey1 = `${currentUser.username}-${activeReceiver}`;
      const chatKey2 = `${activeReceiver}-${currentUser.username}`;
      const chatHistory = messages[chatKey1] || messages[chatKey2] || [];

      chatHistory.forEach(msg => {
        appendMessageToChat(msg);
      });
      document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
    }

    function appendMessageToChat(msg) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `msg-bubble ${msg.sender === currentUser.username ? 'msg-user' : 'msg-bot'}`;
        
        if (msg.type === 'text') {
            msgDiv.innerText = msg.content;
        } else if (msg.type === 'image') {
            msgDiv.innerHTML = `<img src="${msg.content}" alt="Gambar">`;
        } else if (msg.type === 'audio') {
            msgDiv.innerHTML = `<audio controls src="${msg.content}"></audio>`;
        } else if (msg.type === 'video') {
            msgDiv.innerHTML = `<video controls src="${msg.content}"></video>`;
        }
        
        const timestampSpan = document.createElement('span');
        timestampSpan.className = 'msg-timestamp';
        timestampSpan.innerText = msg.timestamp;
        msgDiv.appendChild(timestampSpan);

        document.getElementById('chat-messages').appendChild(msgDiv);
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
            event.preventDefault(); // Prevent new line in input
        }
    }

    async function sendMessage() {
      const msgInput = document.getElementById('msg-input');
      const fileInput = document.getElementById('file-input');
      const msg = msgInput.value.trim();
      const file = fileInput.files[0];

      if (!msg && !file) return;
      if (!activeReceiver) {
        alert('⚠️ Pilih pengguna atau Gemini AI untuk memulai chat.');
        return;
      }
      
      currentUser.stats.chatsSent++;
      localStorage.setItem('users', JSON.stringify(users));

      // Determine the correct chat key for storing messages
      const chatKey = `${currentUser.username}-${activeReceiver}`;
      if (!messages[chatKey]) messages[chatKey] = [];

      const currentTimestamp = getTimestamp();

      if (msg) {
        const messageObject = { sender: currentUser.username, receiver: activeReceiver, type: 'text', content: msg, timestamp: currentTimestamp };
        messages[chatKey].push(messageObject);
        appendMessageToChat(messageObject);
        new Notification(`📨 Pesan untuk ${users.find(u => u.username === activeReceiver)?.displayName || 'Gemini AI'}`, { body: msg, icon: 'https://cdn-icons-png.flaticon.com/512/732/732200.png' });
      }

      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const fileContent = e.target.result;
          let fileType = 'unknown';
          if (file.type.startsWith('image')) fileType = 'image';
          else if (file.type.startsWith('audio')) fileType = 'audio';
          else if (file.type.startsWith('video')) fileType = 'video';

          const messageObject = { sender: currentUser.username, receiver: activeReceiver, type: fileType, content: fileContent, timestamp: currentTimestamp };
          messages[chatKey].push(messageObject);
          appendMessageToChat(messageObject);
          saveMessages();
        }
        reader.readAsDataURL(file);
      }
      
      saveMessages();
      msgInput.value = '';
      fileInput.value = ''; // Clear file input
      document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;

      // Handle Gemini AI replies
      if (activeReceiver === 'gemini') {
        const reply = await geminiReply(msg);
        const geminiMessageObject = { sender: activeReceiver, receiver: currentUser.username, type: 'text', content: reply, timestamp: getTimestamp() };
        
        messages[chatKey].push(geminiMessageObject);
        appendMessageToChat(geminiMessageObject);
        saveMessages();
        new Notification('🤖 Gemini Membalas', { body: reply, icon: 'https://www.gstatic.com/images/branding/product/2x/gemini_2023_color_256dp.png' });
      } else {
        // Simulate message received for other users (in a real app, this would be via WebSocket)
        const receiverUser = users.find(u => u.username === activeReceiver);
        if (receiverUser) {
          receiverUser.stats.chatsReceived++;
          localStorage.setItem('users', JSON.stringify(users));
        }
      }
      if (currentUser.role === 'admin') showAdminStats();
    }

    async function geminiReply(prompt) {
      if (!prompt) return 'Hai! Ada yang bisa saya bantu?';
      try {
        const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY'; // GANTI DENGAN API KEY GEMINI ASLI ANDA
        if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
          return '⚠️ Harap ganti "YOUR_GEMINI_API_KEY" dengan kunci API Gemini yang valid untuk menggunakan fitur ini.';
        }
        const res = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
          }
        );
        const data = await res.json();
        const replyText = data.candidates?.[0]?.content?.parts?.[0]?.text || '❌ Tidak bisa membalas';
        return replyText;
      } catch (e) {
        console.error('Gemini API Error:', e);
        return '❌ Gagal koneksi ke Gemini API atau terjadi kesalahan. Pastikan API key Anda benar.';
      }
    }

    // --- Admin Functions ---
    function showAdminStats() {
      let statsDiv = document.getElementById('admin-stats');
      let totalLogins = users.reduce((sum, u) => sum + u.stats.logins, 0);
      let totalChatsSent = users.reduce((sum, u) => sum + u.stats.chatsSent, 0);
      let totalChatsReceived = users.reduce((sum, u) => sum + u.stats.chatsReceived, 0);
      
      statsDiv.innerHTML = `
        👥 Total Akun: <b>${users.length}</b><br>
        🕒 Total Login: <b>${totalLogins}</b><br>
        💬 Pesan Terkirim: <b>${totalChatsSent}</b><br>
        📥 Pesan Diterima: <b>${totalChatsReceived}</b>
      `;
      statsDiv.style.display = 'block';
    }

    function showAllUserStats() {
      openModal('Statistik Pengguna Lengkap', `
        <div style="max-height: 350px; overflow-y: auto;">
          <table style="width:100%; border-collapse: collapse; font-size: 0.9em;">
            <thead>
              <tr style="background-color: #f0f8ff;">
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left; border-top-left-radius: 10px;">Username</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Nama</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Role</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Login</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Kirim</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Terima</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left; border-top-right-radius: 10px;">Banned</th>
              </tr>
            </thead>
            <tbody>
              ${users.map(u => `
                <tr style="${u.banned ? 'background-color: #ffe6e6;' : ''}">
                  <td style="padding: 10px; border: 1px solid #eee;">${u.username}</td>
                  <td style="padding: 10px; border: 1px solid #eee;">${u.displayName}</td>
                  <td style="padding: 10px; border: 1px solid #eee;">${u.role}</td>
                  <td style="padding: 10px; border: 1px solid #eee;">${u.stats.logins}</td>
                  <td style="padding: 10px; border: 1px solid #eee;">${u.stats.chatsSent}</td>
                  <td style="padding: 10px; border: 1px solid #eee;">${u.stats.chatsReceived}</td>
                  <td style="padding: 10px; border: 1px solid #eee; color: ${u.banned ? 'red' : 'green'}; font-weight: bold;">${u.banned ? 'Ya' : 'Tidak'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `, 'Tutup', null);
    }

    function showBanUserModal() {
      const banOptions = users.filter(u => u.username !== currentUser.username && u.role !== 'admin' && !u.banned)
                               .map(u => `<option value="${u.username}">${u.displayName} (${u.username})</option>`).join('');
      const unbanOptions = users.filter(u => u.banned)
                                 .map(u => `<option value="${u.username}">${u.displayName} (${u.username})</option>`).join('');
      
      openModal('Kelola Ban Pengguna', `
        <div style="margin-bottom: 20px;">
            <p>Pilih pengguna yang ingin Anda <b>ban</b>:</p>
            <select id="ban-user-select" style="width:100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; margin-top: 10px;">
              ${banOptions || '<option value="">Tidak ada pengguna untuk di-ban</option>'}
            </select>
            <button class="danger" style="margin-top: 15px; background: ${banOptions ? 'var(--danger-color)' : '#ccc'};" ${!banOptions ? 'disabled' : ''} onclick="confirmBanUser()">
                <i class="fas fa-user-slash"></i> Ban Pengguna Dipilih
            </button>
        </div>
        <div>
            <p>Pilih pengguna yang ingin Anda <b>unban</b>:</p>
            <select id="unban-user-select" style="width:100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; margin-top: 10px;">
              ${unbanOptions || '<option value="">Tidak ada pengguna untuk di-unban</option>'}
            </select>
            <button class="success" style="margin-top: 15px; background: ${unbanOptions ? 'var(--success-color)' : '#ccc'};" ${!unbanOptions ? 'disabled' : ''} onclick="confirmUnbanUser()">
                <i class="fas fa-check-circle"></i> Unban Pengguna Dipilih
            </button>
        </div>
      `, 'Tutup', null); // No global confirm action for this multi-action modal
      document.getElementById('modal-confirm-btn').style.display = 'none'; // Hide default confirm button
    }

    function confirmBanUser() {
        const selectElement = document.getElementById('ban-user-select');
        if (!selectElement || !selectElement.value) {
            alert('Pilih pengguna yang valid untuk di-ban.');
            return;
        }
        const usernameToBan = selectElement.value;
        const userIndex = users.findIndex(u => u.username === usernameToBan);
        if (userIndex > -1) {
            if (confirm(`Anda yakin ingin mem-ban pengguna ${users[userIndex].displayName} (${usernameToBan})?`)) {
                users[userIndex].banned = true;
                localStorage.setItem('users', JSON.stringify(users));
                alert(`Pengguna ${users[userIndex].displayName} berhasil di-ban.`);
                refreshUserList();
                showAdminStats();
                closeModal(); // Close after action
            }
        }
    }

    function confirmUnbanUser() {
        const selectElement = document.getElementById('unban-user-select');
        if (!selectElement || !selectElement.value) {
            alert('Pilih pengguna yang valid untuk di-unban.');
            return;
        }
        const usernameToUnban = selectElement.value;
        const userIndex = users.findIndex(u => u.username === usernameToUnban);
        if (userIndex > -1) {
            if (confirm(`Anda yakin ingin meng-unban pengguna ${users[userIndex].displayName} (${usernameToUnban})?`)) {
                users[userIndex].banned = false;
                localStorage.setItem('users', JSON.stringify(users));
                alert(`Pengguna ${users[userIndex].displayName} berhasil di-unban.`);
                refreshUserList();
                showAdminStats();
                closeModal(); // Close after action
            }
        }
    }

    function showDeleteUserModal() {
      const userOptions = users.filter(u => u.username !== currentUser.username && u.role !== 'admin')
                               .map(u => `<option value="${u.username}">${u.displayName} (${u.username})</option>`).join('');
      if (!userOptions) {
        alert('Tidak ada pengguna yang bisa dihapus.');
        return;
      }
      openModal('Hapus Pengguna Permanen', `
        <p><b>Peringatan:</b> Aksi ini tidak dapat dibatalkan. Semua data chat pengguna akan hilang.</p>
        <p>Pilih pengguna yang ingin Anda hapus:</p>
        <select id="delete-user-select">
          ${userOptions}
        </select>
      `, 'Hapus Sekarang', () => {
        const usernameToDelete = document.getElementById('delete-user-select').value;
        const userIndex = users.findIndex(u => u.username === usernameToDelete);
        if (userIndex > -1) {
          if (confirm(`ANDA YAKIN INGIN MENGHAPUS PENGGUNA ${users[userIndex].displayName} (${usernameToDelete}) BESERTA SEMUA DATANYA? TINDAKAN INI PERMANEN!`)) {
            users.splice(userIndex, 1);
            // Also delete their chat history
            for (const key in messages) {
              if (key.includes(usernameToDelete)) {
                delete messages[key];
              }
            }
            localStorage.setItem('users', JSON.stringify(users));
            saveMessages();
            alert(`Pengguna ${usernameToDelete} berhasil dihapus secara permanen.`);
            refreshUserList();
            showAdminStats();
            if (activeReceiver === usernameToDelete) {
                activeReceiver = null;
                updateChatHeader(`Pilih Pengguna untuk Chat`);
                document.getElementById('chat-partner-avatar').innerText = '';
                document.getElementById('chat-partner-status').innerText = '';
                document.getElementById('chat-messages').innerHTML = '';
            }
          }
        }
        closeModal();
      });
    }

    // --- User Control Functions ---
    function showEditProfileModal() {
      openModal('Edit Profil Anda', `
        <p>Nama Panggilan Anda:</p>
        <input type="text" id="edit-display-name" placeholder="Nama Panggilan Baru" value="${currentUser.displayName}">
        <p>Username Anda:</p>
        <input type="text" id="edit-username" placeholder="Username Baru (tidak bisa diubah)" value="${currentUser.username}" disabled>
        <p>Bio/Status Anda:</p>
        <textarea id="edit-bio" placeholder="Tulis bio singkat Anda">${currentUser.bio || ''}</textarea>
      `, 'Simpan Perubahan', () => {
        const newDisplayName = document.getElementById('edit-display-name').value.trim();
        const newBio = document.getElementById('edit-bio').value.trim();

        if (newDisplayName && newDisplayName !== currentUser.displayName) {
          currentUser.displayName = newDisplayName;
        }
        if (newBio !== currentUser.bio) { // Allow empty bio
          currentUser.bio = newBio;
        }
        
        localStorage.setItem('users', JSON.stringify(users));
        alert('Profil berhasil diperbarui!');
        updateChatHeader('Selamat Datang, ' + currentUser.displayName + (currentUser.role === 'admin' ? ' <i class="fas fa-check-circle admin-badge"></i>' : ''));
        document.getElementById('chat-partner-status').innerText = currentUser.bio || 'Status Anda';
        refreshUserList();
        closeModal();
      });
    }

    function changePassword() {
      openModal('Ganti Password', `
        <input type="password" id="old-password" placeholder="Password Lama Anda">
        <input type="password" id="new-password" placeholder="Password Baru (min 6 karakter)">
        <input type="password" id="confirm-new-password" placeholder="Konfirmasi Password Baru">
      `, 'Ganti Password', () => {
        const oldPass = document.getElementById('old-password').value;
        const newPass = document.getElementById('new-password').value;
        const confirmNewPass = document.getElementById('confirm-new-password').value;

        if (oldPass !== currentUser.password) {
          alert('Password lama salah.');
          return;
        }
        if (newPass.length < 6) {
          alert('Password baru minimal 6 karakter.');
          return;
        }
        if (newPass !== confirmNewPass) {
          alert('Konfirmasi password baru tidak cocok.');
          return;
        }

        currentUser.password = newPass;
        localStorage.setItem('users', JSON.stringify(users));
        alert('Password berhasil diganti.');
        closeModal();
      });
    }

    // --- Call Simulation Modals ---
    function showCallModal(type) {
        const targetUser = users.find(u => u.username === activeReceiver);
        const targetName = targetUser ? targetUser.displayName : (activeReceiver === 'gemini' ? 'Gemini AI' : 'Pengguna Tidak Dikenal');
        
        if (!activeReceiver || activeReceiver === 'gemini') {
            alert('Pilih pengguna lain untuk melakukan panggilan.');
            return;
        }

        openModal(`Panggilan ${type === 'video' ? 'Video' : 'Suara'}`, `
            <p style="text-align: center; font-size: 1.2em; font-weight: 600;">
                <i class="fas fa-circle-notch fa-spin" style="margin-right: 10px; color: ${type === 'video' ? '#FF6B6B' : '#4FD1C5'};"></i> 
                Menghubungi ${targetName}...
            </p>
            <p style="text-align: center; font-size: 0.9em; color: #777;">(Fitur ini adalah simulasi. Panggilan sungguhan membutuhkan backend.)</p>
        `, 'Akhiri Panggilan', () => {
            alert(`Panggilan ${type === 'video' ? 'video' : 'suara'} dengan ${targetName} diakhiri.`);
            closeModal();
        });
        document.getElementById('modal-confirm-btn').classList.add('danger'); // Make button red for ending call
    }

    // --- Universal Modal Functions ---
    function openModal(title, bodyHtml, confirmText, onConfirm) {
      document.getElementById('modal-title').innerText = title;
      document.getElementById('modal-body').innerHTML = bodyHtml;
      const confirmBtn = document.getElementById('modal-confirm-btn');
      confirmBtn.innerText = confirmText;
      confirmBtn.onclick = onConfirm;
      document.getElementById('modal-backdrop').classList.add('show');
      confirmBtn.style.display = onConfirm ? 'block' : 'none'; // Show/hide confirm button based on if onConfirm is provided
      document.getElementById('modal-actions').style.justifyContent = onConfirm ? 'flex-end' : 'center'; // Adjust button alignment
      document.getElementById('modal-confirm-btn').classList.remove('danger'); // Reset button color
    }

    function closeModal() {
      document.getElementById('modal-backdrop').classList.remove('show');
      document.getElementById('modal-body').innerHTML = ''; // Clear modal body content
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
        refreshUserList(); // Ensure user list is populated initially for admin/user
    });

  </script>
</body>
</html>