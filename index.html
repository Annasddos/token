<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gemini Chat Ultra Premium</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* ---------------------------------- Global Styles ---------------------------------- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primary-color: #6a11cb;
      --secondary-color: #2575fc;
      --gradient-start: #ee7752;
      --gradient-middle: #e73c7e;
      --gradient-end: #23a6d5;
      --text-dark: #333;
      --text-light: #fff;
      --bg-light: rgba(255, 255, 255, 0.95);
      --bg-dark: rgba(0, 0, 0, 0.7);
      --border-light: #e0e0e0;
      --shadow-light: rgba(0, 0, 0, 0.15);
      --shadow-heavy: rgba(0, 0, 0, 0.35);
      --input-bg: #f7f7f7;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --warning-color: #ffc107;
      --info-color: #007bff;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(-45deg, var(--gradient-start), var(--gradient-middle), var(--gradient-end), var(--primary-color));
      background-size: 400% 400%;
      animation: gradientBG 25s ease infinite;
      color: var(--text-dark);
      height: 100vh;
      overflow: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background-color 0.5s ease;
    }

    @keyframes gradientBG {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    /* ---------------------------------- Card & Form Styling ---------------------------------- */
    .card {
      background: var(--bg-light);
      border-radius: 30px;
      padding: 45px;
      box-shadow: 0 25px 60px var(--shadow-heavy);
      max-width: 550px;
      width: 90%;
      margin: auto;
      backdrop-filter: blur(15px);
      transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      transform: scale(0.9) translateY(20px);
      opacity: 0;
      animation: fadeInZoomIn 0.8s forwards ease-out;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    @keyframes fadeInZoomIn {
      to {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    .card h2 {
      text-align: center;
      margin-bottom: 35px;
      color: var(--text-dark);
      font-weight: 800;
      font-size: 2.5em;
      letter-spacing: 1.5px;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    input[type="text"],
    input[type="password"],
    input[type="email"],
    input[type="number"] {
      width: 100%;
      padding: 20px 25px;
      margin: 18px 0;
      font-size: 1.15em;
      border-radius: 15px;
      border: 1px solid var(--border-light);
      background-color: var(--input-bg);
      transition: all 0.4s ease;
      box-shadow: inset 0 3px 6px rgba(0, 0, 0, 0.08);
      font-family: 'Montserrat', sans-serif;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="email"]:focus,
    input[type="number"]:focus {
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 5px rgba(37, 117, 252, 0.3);
      outline: none;
      background-color: var(--text-light);
    }

    button {
      width: 100%;
      padding: 20px;
      margin-top: 30px;
      font-size: 1.3em;
      border-radius: 15px;
      border: none;
      background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      color: var(--text-light);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      overflow: hidden;
      z-index: 1;
      box-shadow: 0 10px 25px var(--shadow-light);
    }

    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 200%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      z-index: -1;
      transition: transform 0.6s ease;
      transform: skewX(-20deg);
    }

    button:hover::before {
      transform: skewX(-20deg) translateX(120%);
    }

    button:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 15px 35px var(--shadow-heavy);
      background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
    }

    .link {
      color: var(--primary-color);
      cursor: pointer;
      text-align: center;
      margin-top: 25px;
      display: block;
      font-size: 1.05em;
      transition: color 0.3s ease, text-decoration 0.3s ease;
      font-weight: 500;
    }

    .link:hover {
      color: var(--secondary-color);
      text-decoration: underline;
    }

    .message {
      color: var(--danger-color);
      text-align: center;
      margin-top: 20px;
      font-weight: 600;
      font-size: 1.05em;
    }

    /* ---------------------------------- Chat Container ---------------------------------- */
    #chat-container {
      display: none;
      flex-direction: row;
      height: 95vh;
      width: 98vw;
      max-width: 1600px;
      background: var(--bg-light);
      border-radius: 30px;
      box-shadow: 0 25px 70px var(--shadow-heavy);
      overflow: hidden;
      animation: slideInFromTop 0.8s forwards cubic-bezier(0.25, 0.8, 0.25, 1);
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    @keyframes slideInFromTop {
      from {
        transform: translateY(-50px) scale(0.95);
        opacity: 0;
      }
      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    /* ---------------------------------- User List ---------------------------------- */
    #user-list {
      width: 350px;
      background: #eef2f7;
      padding: 30px;
      overflow-y: auto;
      border-right: 2px solid var(--border-light);
      display: flex;
      flex-direction: column;
      position: relative;
      transition: width 0.3s ease;
      flex-shrink: 0;
    }

    #user-list h3 {
      font-size: 2.1em;
      color: var(--text-dark);
      margin-bottom: 30px;
      font-weight: 800;
      position: sticky;
      top: 0;
      background: #eef2f7;
      padding-bottom: 15px;
      z-index: 10;
      border-bottom: 2px solid var(--border-light);
      color: var(--primary-color);
    }

    #user-list ul {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
    }

    #user-list ul li {
      background: var(--text-light);
      margin-bottom: 18px;
      padding: 18px 25px;
      border-radius: 20px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      display: flex;
      align-items: center;
      font-size: 1.1em;
      font-weight: 600;
      color: #555;
      position: relative;
      overflow: hidden;
    }

    #user-list ul li:hover {
      background: #d8eaff;
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
      border: 1px solid var(--secondary-color);
    }

    #user-list ul li.active {
      background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
      color: var(--text-light);
      box-shadow: 0 8px 20px var(--shadow-light);
      transform: translateY(-3px) scale(1.01);
    }

    #user-list ul li.active::before {
      content: '\f00c'; /* Checkmark icon */
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255, 255, 255, 0.7);
      font-size: 1.2em;
    }

    #user-list .user-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background-color: #ccc;
      margin-right: 15px;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-light);
      font-weight: 700;
      font-size: 1.1em;
      flex-shrink: 0;
      border: 2px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      background: linear-gradient(45deg, #FFC14F, #FF6B6B);
    }

    #user-list ul li.active .user-avatar {
      background: var(--text-light);
      color: var(--primary-color);
    }
    
    #user-list .gemini-ai-link {
      background: linear-gradient(90deg, #4CAF50, #8BC34A);
      color: var(--text-light);
      font-weight: 700;
      margin-top: 25px;
      padding: 20px 25px;
      border-radius: 20px;
      cursor: pointer;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      font-size: 1.15em;
      position: relative;
      overflow: hidden;
    }

    #user-list .gemini-ai-link:hover {
      background: linear-gradient(90deg, #8BC34A, #4CAF50);
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    #user-list .gemini-ai-link i {
      margin-right: 12px;
      font-size: 1.4em;
    }

    #user-list hr {
      border: none;
      border-top: 1px dashed var(--border-light);
      margin: 30px 0;
    }

    /* ---------------------------------- Chat Box ---------------------------------- */
    #chat-box {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--text-light);
      position: relative;
    }

    #chat-header {
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      color: var(--text-light);
      padding: 25px 30px;
      font-weight: bold;
      font-size: 2.1em;
      text-align: left;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    #chat-header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: rgba(255, 255, 255, 0.1);
      transform: rotate(30deg);
      animation: headerShine 4s infinite linear;
    }

    @keyframes headerShine {
      0% { transform: rotate(30deg) translate(-50%, -50%); }
      100% { transform: rotate(30deg) translate(50%, 50%); }
    }

    #chat-header span {
      flex-grow: 1;
    }

    #chat-header .chat-options {
      display: flex;
      gap: 15px;
    }

    #chat-header .chat-options button {
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 1.4em;
      padding: 8px;
      border-radius: 50%;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: none;
      margin: 0;
      width: auto;
    }

    #chat-header .chat-options button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }

    #chat-messages {
      flex: 1;
      padding: 25px 30px;
      overflow-y: auto;
      background: #f9fafc;
      display: flex;
      flex-direction: column;
      gap: 15px;
      scroll-behavior: smooth;
    }

    /* ---------------------------------- Message Bubbles ---------------------------------- */
    .msg-bubble {
      margin: 0;
      padding: 16px 22px;
      max-width: 70%;
      border-radius: 25px;
      word-wrap: break-word;
      font-size: 1.05em;
      line-height: 1.5;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      position: relative;
      animation: fadeInMessage 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      transform-origin: bottom;
    }

    @keyframes fadeInMessage {
      from { opacity: 0; transform: translateY(15px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    .msg-user {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: var(--text-light);
      align-self: flex-end;
      text-align: right;
      border-bottom-right-radius: 8px;
      margin-left: auto; /* Push to right */
    }

    .msg-bot {
      background: #e0f7fa; /* Cyan light for bot */
      color: var(--text-dark);
      align-self: flex-start;
      border-bottom-left-radius: 8px;
      margin-right: auto; /* Push to left */
    }

    .msg-user::after {
      content: '';
      position: absolute;
      bottom: 0;
      right: -8px; /* Adjusted for larger radius */
      width: 15px;
      height: 15px;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border-bottom-left-radius: 100%;
      z-index: -1;
    }

    .msg-bot::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: -8px; /* Adjusted for larger radius */
      width: 15px;
      height: 15px;
      background: #e0f7fa;
      border-bottom-right-radius: 100%;
      z-index: -1;
    }

    .msg-bubble img,
    .msg-bubble audio,
    .msg-bubble video {
      max-width: 100%;
      border-radius: 15px;
      display: block;
      margin-top: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .msg-timestamp {
      font-size: 0.75em;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 5px;
      display: block;
      opacity: 0.8;
    }
    .msg-bot .msg-timestamp {
      color: rgba(0, 0, 0, 0.5);
    }

    /* ---------------------------------- Chat Input ---------------------------------- */
    #chat-input {
      display: flex;
      padding: 20px 30px;
      background: var(--text-light);
      border-top: 1px solid var(--border-light);
      box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.05);
      align-items: center;
      gap: 15px;
      flex-shrink: 0;
    }

    #chat-input input[type="text"] {
      flex: 1;
      padding: 18px 25px;
      border-radius: 30px;
      border: 1px solid var(--border-light);
      font-size: 1.15em;
      background-color: var(--input-bg);
      transition: all 0.3s ease;
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.08);
      font-family: 'Montserrat', sans-serif;
    }

    #chat-input input[type="text"]:focus {
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 5px rgba(37, 117, 252, 0.2);
      outline: none;
    }

    #chat-input input[type="file"] {
      display: none;
    }

    #chat-input button {
      padding: 18px 22px;
      border-radius: 50%; /* Circle buttons */
      font-size: 1.3em;
      margin: 0;
      width: 60px; /* Fixed width/height for circle */
      height: 60px;
      background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
      color: var(--text-light);
      border: none;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.18);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-shrink: 0;
    }

    #chat-input button:hover {
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
    }

    #chat-input button.send-button {
        background: linear-gradient(45deg, var(--primary-color), var(--gradient-end));
    }
    #chat-input button.send-button:hover {
        background: linear-gradient(45deg, var(--gradient-end), var(--primary-color));
    }

    /* ---------------------------------- Controls Panel ---------------------------------- */
    .controls-panel {
      margin-top: 30px;
      padding: 25px;
      background: var(--text-light);
      border-radius: 20px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      border: 1px solid var(--border-light);
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .controls-panel h4 {
      font-size: 1.4em;
      margin-bottom: 15px;
      color: var(--text-dark);
      border-bottom: 2px solid var(--border-light);
      padding-bottom: 10px;
      font-weight: 700;
      color: var(--primary-color);
    }

    .controls-panel button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 15px;
      border-radius: 15px;
      font-size: 1.05em;
      margin: 0; /* Override default button margin */
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .controls-panel button i {
      margin-right: 10px;
      font-size: 1.1em;
    }

    .controls-panel button.danger { background: var(--danger-color); }
    .controls-panel button.success { background: var(--success-color); }
    .controls-panel button.warning { background: var(--warning-color); }
    .controls-panel button.info { background: var(--info-color); }

    .controls-panel button:hover {
      transform: translateY(-3px) scale(1.01);
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      filter: brightness(1.1);
    }

    .stats {
      font-size: 0.95em;
      background: #f0f8ff;
      padding: 15px;
      margin-top: 20px;
      border-radius: 12px;
      border: 1px solid #d9e6f2;
      color: #444;
      line-height: 1.7;
      box-shadow: inset 0 1px 4px rgba(0,0,0,0.08);
    }

    /* ---------------------------------- Modal Styles ---------------------------------- */
    #modal-backdrop {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }

    #modal-backdrop.show {
      opacity: 1;
      pointer-events: all;
    }

    #modal-content {
      background: var(--text-light);
      border-radius: 25px;
      padding: 35px;
      box-shadow: 0 15px 40px var(--shadow-heavy);
      max-width: 450px;
      width: 90%;
      transform: scale(0.9);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    #modal-backdrop.show #modal-content {
      transform: scale(1);
      opacity: 1;
    }

    #modal-title {
      margin-bottom: 25px;
      text-align: center;
      color: var(--primary-color);
      font-weight: 700;
      font-size: 1.8em;
    }

    #modal-body p {
      margin-bottom: 15px;
      line-height: 1.6;
      color: #555;
    }

    #modal-body input {
      margin-bottom: 10px;
    }

    #modal-body select {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 10px;
      border: 1px solid var(--border-light);
      background-color: var(--input-bg);
      font-size: 1em;
    }

    #modal-actions {
      margin-top: 30px;
      display: flex;
      justify-content: flex-end;
      gap: 15px;
    }

    #modal-actions button {
      width: auto;
      padding: 12px 25px;
      font-size: 1.05em;
      margin: 0;
      border-radius: 12px;
      box-shadow: none;
    }

    #modal-actions button.cancel-btn { background: #6c757d; }
    #modal-actions button.confirm-btn { background: linear-gradient(45deg, var(--info-color), var(--primary-color)); }
    #modal-actions button.confirm-btn:hover { background: linear-gradient(45deg, var(--primary-color), var(--info-color)); }

    /* ---------------------------------- Responsive Design ---------------------------------- */
    @media (max-width: 992px) {
      #user-list {
        width: 300px;
      }
      #chat-header {
        font-size: 1.8em;
        padding: 20px;
      }
      #chat-input input[type="text"] {
        padding: 15px 20px;
        font-size: 1em;
      }
      #chat-input button {
        width: 50px;
        height: 50px;
        font-size: 1.1em;
      }
      .msg-bubble {
        padding: 14px 20px;
        font-size: 1em;
      }
    }

    @media (max-width: 768px) {
      body {
        align-items: flex-start;
        padding-top: 20px;
      }
      .card {
        padding: 35px;
        margin: 20px auto;
        width: 95%;
        border-radius: 25px;
      }
      .card h2 {
        font-size: 2em;
        margin-bottom: 25px;
      }
      input[type="text"], input[type="password"], input[type="email"], input[type="number"] {
        padding: 16px 20px;
        margin: 15px 0;
        font-size: 1em;
        border-radius: 12px;
      }
      button {
        padding: 16px;
        font-size: 1.1em;
        border-radius: 12px;
        margin-top: 20px;
      }

      #chat-container {
        flex-direction: column;
        height: 98vh;
        width: 98vw;
        border-radius: 20px;
      }
      #user-list {
        width: 100%;
        height: 280px; /* Fixed height for user list on small screens */
        border-right: none;
        border-bottom: 2px solid var(--border-light);
        padding: 20px;
      }
      #user-list h3 {
        font-size: 1.6em;
        margin-bottom: 20px;
      }
      #user-list ul li {
        padding: 15px 20px;
        margin-bottom: 12px;
        font-size: 1em;
        border-radius: 15px;
      }
      #user-list .gemini-ai-link {
        padding: 15px 20px;
        font-size: 1em;
        margin-top: 20px;
        border-radius: 15px;
      }

      #chat-box {
        flex: 1;
      }
      #chat-header {
        font-size: 1.6em;
        padding: 18px 25px;
      }
      #chat-header .chat-options button {
        font-size: 1.2em;
        padding: 6px;
      }
      #chat-messages {
        padding: 15px 20px;
        gap: 10px;
      }
      .msg-bubble {
        max-width: 90%;
        padding: 12px 18px;
        font-size: 0.95em;
        border-radius: 20px;
      }
      .msg-user::after, .msg-bot::after {
        width: 12px;
        height: 12px;
        left: -6px;
        right: -6px;
      }
      #chat-input {
        flex-wrap: wrap;
        padding: 15px 20px;
        gap: 10px;
      }
      #chat-input input[type="text"] {
        flex-basis: 100%;
        margin-bottom: 5px;
        padding: 14px 18px;
        border-radius: 25px;
      }
      #chat-input button {
        width: 45px;
        height: 45px;
        font-size: 1.05em;
        padding: 0;
      }
      #modal-content {
        padding: 30px;
        border-radius: 20px;
      }
      #modal-title {
        font-size: 1.5em;
        margin-bottom: 20px;
      }
      #modal-actions button {
        padding: 10px 20px;
        font-size: 0.95em;
        border-radius: 10px;
      }
    }
    @media (max-width: 480px) {
      .card {
        padding: 25px;
      }
      .card h2 {
        font-size: 1.8em;
      }
      input[type="text"], input[type="password"] {
        padding: 14px 18px;
      }
      button {
        padding: 14px;
        font-size: 1em;
      }
      #user-list h3 {
        font-size: 1.4em;
      }
      #user-list ul li, #user-list .gemini-ai-link {
        font-size: 0.95em;
        padding: 12px 15px;
      }
      #chat-header {
        font-size: 1.4em;
        padding: 15px 20px;
      }
      #chat-input button {
        width: 40px;
        height: 40px;
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>
  <div id="auth-section">
    <div class="login-form card" id="login-card">
      <h2>Masuk ke Gemini Chat</h2>
      <input id="login-username" type="text" placeholder="Username Anda">
      <input id="login-password" type="password" placeholder="Password Anda">
      <button onclick="login()">Login</button>
      <p class="link" onclick="toggleRegister(true)">Belum punya akun? Daftar sekarang</p>
      <p id="login-msg" class="message"></p>
    </div>
    <div class="register-form card" id="register-card" style="display:none">
      <h2>Buat Akun Baru</h2>
      <input id="reg-name" type="text" placeholder="Nama Lengkap Anda">
      <input id="reg-username" type="text" placeholder="Username Pilihan">
      <input id="reg-password" type="password" placeholder="Password Kuat">
      <button onclick="register()">Daftar</button>
      <p class="link" onclick="toggleRegister(false)">Sudah punya akun? Login</p>
      <p id="reg-msg" class="message"></p>
    </div>
  </div>

  <div id="chat-container">
    <div id="user-list">
      <h3>Pengguna Online</h3>
      <ul id="user-ul"></ul>
      <hr>
      <p class="gemini-ai-link" onclick="startChat('gemini')"><i class="fas fa-robot"></i> Chat dengan Gemini AI</p>

      <div class="controls-panel" id="admin-controls-panel" style="display:none;">
        <h4><i class="fas fa-user-shield"></i> Kontrol Admin</h4>
        <button class="info" onclick="showAllUserStats()"><i class="fas fa-chart-line"></i> Statistik Pengguna</button>
        <button class="warning" onclick="showBanUserModal()"><i class="fas fa-user-slash"></i> Kelola Ban Pengguna</button>
        <button class="danger" onclick="showDeleteUserModal()"><i class="fas fa-user-minus"></i> Hapus Pengguna</button>
        <div id="admin-stats" class="stats"></div>
      </div>

      <div class="controls-panel" id="user-controls-panel" style="display:none;">
        <h4><i class="fas fa-user-cog"></i> Pengaturan Akun</h4>
        <button class="success" onclick="changeDisplayName()"><i class="fas fa-signature"></i> Ganti Nama Tampilan</button>
        <button class="info" onclick="changePassword()"><i class="fas fa-key"></i> Ganti Password</button>
        <button class="danger" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </div>

    <div id="chat-box">
      <div id="chat-header">
        <span>Pilih Pengguna untuk Chat</span>
        <div class="chat-options">
          <button title="Panggilan Video (Simulasi)" onclick="showCallModal('video')"><i class="fas fa-video"></i></button>
          <button title="Panggilan Suara (Simulasi)" onclick="showCallModal('audio')"><i class="fas fa-phone"></i></button>
          <button title="Lihat Profil (Simulasi)" onclick="showProfileModal()"><i class="fas fa-info-circle"></i></button>
        </div>
      </div>
      <div id="chat-messages"></div>
      <div id="chat-input">
        <input id="msg-input" type="text" placeholder="Ketik pesan Anda..." onkeypress="handleKeyPress(event)">
        <input type="file" id="file-input" accept="image/*,audio/*,video/*">
        <button title="Lampirkan File" onclick="document.getElementById('file-input').click()"><i class="fas fa-paperclip"></i></button>
        <button title="Kirim Pesan" class="send-button" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <div id="modal-backdrop">
    <div id="modal-content">
      <h3 id="modal-title"></h3>
      <div id="modal-body"></div>
      <div id="modal-actions">
        <button class="cancel-btn" onclick="closeModal()">Batal</button>
        <button id="modal-confirm-btn" class="confirm-btn"></button>
      </div>
    </div>
  </div>

  <script>
    // Request Notification permission on page load
    Notification.requestPermission();

    // Initial user data. Annas is admin.
    let users = JSON.parse(localStorage.getItem('users')) || [
      { username: 'annas', password: 'annas', name: 'Admin Annas', role: 'admin', banned: false, stats: { logins: 0, chatsSent: 0, chatsReceived: 0 } }
    ];
    let currentUser = null;
    let activeReceiver = null;
    let messages = JSON.parse(localStorage.getItem('messages')) || {}; // Store messages by sender-receiver pair

    // Function to get current timestamp formatted
    function getTimestamp() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
    }

    // --- Authentication Functions ---
    function toggleRegister(show) {
      document.getElementById('register-card').style.display = show ? 'block' : 'none';
      document.getElementById('login-card').style.display = show ? 'none' : 'block';
      document.getElementById('reg-msg').innerText = '';
      document.getElementById('login-msg').innerText = '';
      if (show) {
        document.getElementById('register-card').style.animation = 'fadeInZoomIn 0.8s forwards ease-out';
      } else {
        document.getElementById('login-card').style.animation = 'fadeInZoomIn 0.8s forwards ease-out';
      }
    }

    function register() {
      const name = document.getElementById('reg-name').value.trim();
      const username = document.getElementById('reg-username').value.trim();
      const password = document.getElementById('reg-password').value.trim();

      if (!name || !username || !password) {
        return document.getElementById('reg-msg').innerText = 'âš ï¸ Semua kolom harus diisi.';
      }
      if (users.find(u => u.username === username)) {
        return document.getElementById('reg-msg').innerText = 'âš ï¸ Username sudah digunakan.';
      }

      users.push({ username, password, name, role: 'user', banned: false, stats: { logins: 0, chatsSent: 0, chatsReceived: 0 } });
      localStorage.setItem('users', JSON.stringify(users));
      toggleRegister(false);
      alert('âœ… Akun berhasil dibuat! Silakan login.');
      document.getElementById('reg-name').value = '';
      document.getElementById('reg-username').value = '';
      document.getElementById('reg-password').value = '';
    }

    function login() {
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value.trim();
      const user = users.find(u => u.username === username && u.password === password);

      if (!user) {
        return document.getElementById('login-msg').innerText = 'âš ï¸ Username atau password salah. Mohon daftar jika belum punya akun.';
      }
      if (user.banned) {
        return document.getElementById('login-msg').innerText = 'ðŸš« Akun Anda telah dibanned. Silakan hubungi admin.';
      }

      currentUser = user;
      currentUser.stats.logins++;
      localStorage.setItem('users', JSON.stringify(users));
      
      document.getElementById('auth-section').style.display = 'none';
      document.getElementById('chat-container').style.display = 'flex';
      
      document.getElementById('chat-header').querySelector('span').innerText = `Selamat Datang, ${currentUser.name}!`;
      refreshUserList();
      
      if (currentUser.role === 'admin') {
        document.getElementById('admin-controls-panel').style.display = 'flex';
        showAdminStats();
      } else {
        document.getElementById('user-controls-panel').style.display = 'flex';
      }
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
    }

    function logout() {
      currentUser = null;
      activeReceiver = null;
      document.getElementById('auth-section').style.display = 'flex';
      document.getElementById('chat-container').style.display = 'none';
      document.getElementById('admin-controls-panel').style.display = 'none';
      document.getElementById('user-controls-panel').style.display = 'none';
      document.getElementById('login-msg').innerText = 'Anda telah berhasil logout.';
      // Reset chat display
      document.getElementById('chat-header').querySelector('span').innerText = 'Pilih Pengguna untuk Chat';
      document.getElementById('chat-messages').innerHTML = '';
    }

    // --- User List and Chat Management ---
    function refreshUserList() {
      const ul = document.getElementById('user-ul');
      ul.innerHTML = '';
      
      // Filter out current user and banned users (unless admin viewing)
      const usersToDisplay = users.filter(u => u.username !== currentUser.username && !u.banned);

      usersToDisplay.forEach(u => {
        const li = document.createElement('li');
        li.setAttribute('data-username', u.username);
        li.onclick = () => startChat(u.username);
        
        const avatarInitial = u.name.charAt(0).toUpperCase();
        li.innerHTML = `
          <div class="user-avatar">${avatarInitial}</div>
          <span>${u.name} (${u.username})</span>
        `;
        ul.appendChild(li);
      });
      // Optionally re-select active chat if user list refreshes
      if (activeReceiver) {
        const activeLi = ul.querySelector(`li[data-username="${activeReceiver}"]`);
        if (activeLi) activeLi.classList.add('active');
      }
    }

    function startChat(username) {
      if (activeReceiver) {
        const prevActiveLi = document.querySelector(`#user-ul li.active`);
        if (prevActiveLi) prevActiveLi.classList.remove('active');
      }

      activeReceiver = username;
      document.getElementById('chat-messages').innerHTML = '';
      const receiverName = users.find(u => u.username === username)?.name || 'Gemini AI';
      document.getElementById('chat-header').querySelector('span').innerText = `Chat dengan ${receiverName}`;
      
      const currentActiveLi = document.querySelector(`#user-ul li[data-username="${username}"]`);
      if (currentActiveLi) currentActiveLi.classList.add('active');

      loadMessages();
    }

    function saveMessages() {
      localStorage.setItem('messages', JSON.stringify(messages));
    }

    function loadMessages() {
      document.getElementById('chat-messages').innerHTML = '';
      const chatKey1 = `${currentUser.username}-${activeReceiver}`;
      const chatKey2 = `${activeReceiver}-${currentUser.username}`;
      const chatHistory = messages[chatKey1] || messages[chatKey2] || [];

      chatHistory.forEach(msg => {
        appendMessageToChat(msg);
      });
      document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
    }

    function appendMessageToChat(msg) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `msg-bubble ${msg.sender === currentUser.username ? 'msg-user' : 'msg-bot'}`;
        
        if (msg.type === 'text') {
            msgDiv.innerText = msg.content;
        } else if (msg.type === 'image') {
            msgDiv.innerHTML = `<img src="${msg.content}" alt="Gambar">`;
        } else if (msg.type === 'audio') {
            msgDiv.innerHTML = `<audio controls src="${msg.content}"></audio>`;
        } else if (msg.type === 'video') {
            msgDiv.innerHTML = `<video controls src="${msg.content}"></video>`;
        }
        
        const timestampSpan = document.createElement('span');
        timestampSpan.className = 'msg-timestamp';
        timestampSpan.innerText = msg.timestamp;
        msgDiv.appendChild(timestampSpan);

        document.getElementById('chat-messages').appendChild(msgDiv);
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
            event.preventDefault(); // Prevent new line in input
        }
    }

    async function sendMessage() {
      const msgInput = document.getElementById('msg-input');
      const fileInput = document.getElementById('file-input');
      const msg = msgInput.value.trim();
      const file = fileInput.files[0];

      if (!msg && !file) return;
      if (!activeReceiver) {
        alert('âš ï¸ Pilih pengguna atau Gemini AI untuk memulai chat.');
        return;
      }
      
      currentUser.stats.chatsSent++;
      localStorage.setItem('users', JSON.stringify(users));

      // Determine the correct chat key for storing messages
      const chatKey = `${currentUser.username}-${activeReceiver}`;
      if (!messages[chatKey]) messages[chatKey] = [];

      const currentTimestamp = getTimestamp();

      if (msg) {
        const messageObject = { sender: currentUser.username, receiver: activeReceiver, type: 'text', content: msg, timestamp: currentTimestamp };
        messages[chatKey].push(messageObject);
        appendMessageToChat(messageObject);
        new Notification(`ðŸ“¨ Pesan untuk ${users.find(u => u.username === activeReceiver)?.name || 'Gemini AI'}`, { body: msg, icon: 'https://cdn-icons-png.flaticon.com/512/732/732200.png' });
      }

      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const fileContent = e.target.result;
          let fileType = 'unknown';
          if (file.type.startsWith('image')) fileType = 'image';
          else if (file.type.startsWith('audio')) fileType = 'audio';
          else if (file.type.startsWith('video')) fileType = 'video';

          const messageObject = { sender: currentUser.username, receiver: activeReceiver, type: fileType, content: fileContent, timestamp: currentTimestamp };
          messages[chatKey].push(messageObject);
          appendMessageToChat(messageObject);
          saveMessages();
        }
        reader.readAsDataURL(file);
      }
      
      saveMessages();
      msgInput.value = '';
      fileInput.value = ''; // Clear file input
      document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;

      // Handle Gemini AI replies
      if (activeReceiver === 'gemini') {
        const reply = await geminiReply(msg);
        const geminiMessageObject = { sender: activeReceiver, receiver: currentUser.username, type: 'text', content: reply, timestamp: getTimestamp() };
        
        // Gemini's reply is to the current user, so store it under the current chat key
        // Or if you prefer to have a dedicated key for Gemini replies from its perspective: `${activeReceiver}-${currentUser.username}`
        // For simplicity, we'll just add it to the current chat's history.
        messages[chatKey].push(geminiMessageObject);
        appendMessageToChat(geminiMessageObject);
        saveMessages();
        new Notification('ðŸ¤– Gemini Membalas', { body: reply, icon: 'https://www.gstatic.com/images/branding/product/2x/gemini_2023_color_256dp.png' });
      } else {
        // Simulate message received for other users (in a real app, this would be via WebSocket)
        const receiverUser = users.find(u => u.username === activeReceiver);
        if (receiverUser) {
          receiverUser.stats.chatsReceived++;
          localStorage.setItem('users', JSON.stringify(users));
        }
      }
      if (currentUser.role === 'admin') showAdminStats();
    }

    async function geminiReply(prompt) {
      if (!prompt) return 'Hai! Ada yang bisa saya bantu?';
      try {
        const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY'; // GANTI DENGAN API KEY GEMINI ASLI ANDA
        if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY') {
          return 'âš ï¸ Harap ganti "YOUR_GEMINI_API_KEY" dengan kunci API Gemini yang valid untuk menggunakan fitur ini.';
        }
        const res = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`,
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
          }
        );
        const data = await res.json();
        const replyText = data.candidates?.[0]?.content?.parts?.[0]?.text || 'âŒ Tidak bisa membalas';
        return replyText;
      } catch (e) {
        console.error('Gemini API Error:', e);
        return 'âŒ Gagal koneksi ke Gemini API atau terjadi kesalahan. Pastikan API key Anda benar.';
      }
    }

    // --- Admin Functions ---
    function showAdminStats() {
      let statsDiv = document.getElementById('admin-stats');
      let totalLogins = users.reduce((sum, u) => sum + u.stats.logins, 0);
      let totalChatsSent = users.reduce((sum, u) => sum + u.stats.chatsSent, 0);
      let totalChatsReceived = users.reduce((sum, u) => sum + u.stats.chatsReceived, 0);
      
      statsDiv.innerHTML = `
        ðŸ‘¥ Total Akun: <b>${users.length}</b><br>
        ðŸ•’ Total Login: <b>${totalLogins}</b><br>
        ðŸ’¬ Pesan Terkirim: <b>${totalChatsSent}</b><br>
        ðŸ“¥ Pesan Diterima: <b>${totalChatsReceived}</b>
      `;
      statsDiv.style.display = 'block';
    }

    function showAllUserStats() {
      openModal('Statistik Pengguna Lengkap', `
        <div style="max-height: 350px; overflow-y: auto;">
          <table style="width:100%; border-collapse: collapse; font-size: 0.9em;">
            <thead>
              <tr style="background-color: #f0f8ff;">
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left; border-top-left-radius: 10px;">Username</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Nama</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Role</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Login</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Kirim</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Terima</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left; border-top-right-radius: 10px;">Banned</th>
              </tr>
            </thead>
            <tbody>
              ${users.map(u => `
                <tr style="${u.banned ? 'background-color: #ffe6e6;' : ''}">
                  <td style="padding: 10px; border: 1px solid #eee;">${u.username}</td>
                  <td style="padding: 10px; border: 1px solid #eee;">${u.name}</td>
                  <td style="padding: 10px; border: 1px solid #eee;">${u.role}</td>
                  <td style="padding: 10px; border: 1px solid #eee;">${u.stats.logins}</td>
                  <td style="padding: 10px; border: 1px solid #eee;">${u.stats.chatsSent}</td>
                  <td style="padding: 10px; border: 1px solid #eee;">${u.stats.chatsReceived}</td>
                  <td style="padding: 10px; border: 1px solid #eee; color: ${u.banned ? 'red' : 'green'}; font-weight: bold;">${u.banned ? 'Ya' : 'Tidak'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `, 'Tutup', null);
    }

    function showBanUserModal() {
      const banOptions = users.filter(u => u.username !== currentUser.username && u.role !== 'admin' && !u.banned)
                               .map(u => `<option value="${u.username}">${u.name} (${u.username})</option>`).join('');
      const unbanOptions = users.filter(u => u.banned)
                                 .map(u => `<option value="${u.username}">${u.name} (${u.username})</option>`).join('');
      
      openModal('Kelola Ban Pengguna', `
        <div style="margin-bottom: 20px;">
            <p>Pilih pengguna yang ingin Anda <b>ban</b>:</p>
            <select id="ban-user-select" style="width:100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; margin-top: 10px;">
              ${banOptions || '<option value="">Tidak ada pengguna untuk di-ban</option>'}
            </select>
            <button class="danger" style="margin-top: 15px; background: ${banOptions ? 'var(--danger-color)' : '#ccc'};" ${!banOptions ? 'disabled' : ''} onclick="confirmBanUser()">
                <i class="fas fa-user-slash"></i> Ban Pengguna Dipilih
            </button>
        </div>
        <div>
            <p>Pilih pengguna yang ingin Anda <b>unban</b>:</p>
            <select id="unban-user-select" style="width:100%; padding: 12px; border-radius: 10px; border: 1px solid #ccc; margin-top: 10px;">
              ${unbanOptions || '<option value="">Tidak ada pengguna untuk di-unban</option>'}
            </select>
            <button class="success" style="margin-top: 15px; background: ${unbanOptions ? 'var(--success-color)' : '#ccc'};" ${!unbanOptions ? 'disabled' : ''} onclick="confirmUnbanUser()">
                <i class="fas fa-check-circle"></i> Unban Pengguna Dipilih
            </button>
        </div>
      `, 'Tutup', null); // No global confirm action for this multi-action modal
      document.getElementById('modal-confirm-btn').style.display = 'none'; // Hide default confirm button
    }

    function confirmBanUser() {
        const selectElement = document.getElementById('ban-user-select');
        if (!selectElement || !selectElement.value) {
            alert('Pilih pengguna yang valid untuk di-ban.');
            return;
        }
        const usernameToBan = selectElement.value;
        const userIndex = users.findIndex(u => u.username === usernameToBan);
        if (userIndex > -1) {
            if (confirm(`Anda yakin ingin mem-ban pengguna ${users[userIndex].name} (${usernameToBan})?`)) {
                users[userIndex].banned = true;
                localStorage.setItem('users', JSON.stringify(users));
                alert(`Pengguna ${users[userIndex].name} berhasil di-ban.`);
                refreshUserList();
                showAdminStats();
                closeModal(); // Close after action
            }
        }
    }

    function confirmUnbanUser() {
        const selectElement = document.getElementById('unban-user-select');
        if (!selectElement || !selectElement.value) {
            alert('Pilih pengguna yang valid untuk di-unban.');
            return;
        }
        const usernameToUnban = selectElement.value;
        const userIndex = users.findIndex(u => u.username === usernameToUnban);
        if (userIndex > -1) {
            if (confirm(`Anda yakin ingin meng-unban pengguna ${users[userIndex].name} (${usernameToUnban})?`)) {
                users[userIndex].banned = false;
                localStorage.setItem('users', JSON.stringify(users));
                alert(`Pengguna ${users[userIndex].name} berhasil di-unban.`);
                refreshUserList();
                showAdminStats();
                closeModal(); // Close after action
            }
        }
    }

    function showDeleteUserModal() {
      const userOptions = users.filter(u => u.username !== currentUser.username && u.role !== 'admin')
                               .map(u => `<option value="${u.username}">${u.name} (${u.username})</option>`).join('');
      if (!userOptions) {
        alert('Tidak ada pengguna yang bisa dihapus.');
        return;
      }
      openModal('Hapus Pengguna', `
        <p><b>Peringatan:</b> Aksi ini tidak dapat dibatalkan. Semua data chat pengguna akan hilang.</p>
        <p>Pilih pengguna yang ingin Anda hapus:</p>
        <select id="delete-user-select">
          ${userOptions}
        </select>
      `, 'Hapus Sekarang', () => {
        const usernameToDelete = document.getElementById('delete-user-select').value;
        const userIndex = users.findIndex(u => u.username === usernameToDelete);
        if (userIndex > -1) {
          if (confirm(`ANDA YAKIN INGIN MENGHAPUS PENGGUNA ${users[userIndex].name} (${usernameToDelete}) BESERTA SEMUA DATANYA? TINDAKAN INI PERMANEN!`)) {
            users.splice(userIndex, 1);
            // Also delete their chat history
            for (const key in messages) {
              if (key.includes(usernameToDelete)) {
                delete messages[key];
              }
            }
            localStorage.setItem('users', JSON.stringify(users));
            saveMessages();
            alert(`Pengguna ${usernameToDelete} berhasil dihapus.`);
            refreshUserList();
            showAdminStats();
            if (activeReceiver === usernameToDelete) {
                activeReceiver = null;
                document.getElementById('chat-header').querySelector('span').innerText = `Pilih Pengguna untuk Chat`;
                document.getElementById('chat-messages').innerHTML = '';
            }
          }
        }
        closeModal();
      });
    }

    // --- User Control Functions ---
    function changeDisplayName() {
      openModal('Ganti Nama Tampilan', `
        <p>Nama tampilan Anda saat ini: <b>${currentUser.name}</b></p>
        <input type="text" id="new-display-name" placeholder="Nama Tampilan Baru" value="${currentUser.name}">
      `, 'Ganti', () => {
        const newName = document.getElementById('new-display-name').value.trim();
        if (newName && newName !== currentUser.name) {
          currentUser.name = newName;
          localStorage.setItem('users', JSON.stringify(users));
          alert('Nama tampilan berhasil diganti.');
          document.getElementById('chat-header').querySelector('span').innerText = `Selamat Datang, ${currentUser.name}!`;
          refreshUserList();
        } else {
          alert('Nama tampilan tidak boleh kosong atau sama dengan yang lama.');
        }
        closeModal();
      });
    }

    function changePassword() {
      openModal('Ganti Password', `
        <input type="password" id="old-password" placeholder="Password Lama Anda">
        <input type="password" id="new-password" placeholder="Password Baru (min 6 karakter)">
        <input type="password" id="confirm-new-password" placeholder="Konfirmasi Password Baru">
      `, 'Ganti Password', () => {
        const oldPass = document.getElementById('old-password').value;
        const newPass = document.getElementById('new-password').value;
        const confirmNewPass = document.getElementById('confirm-new-password').value;

        if (oldPass !== currentUser.password) {
          alert('Password lama salah.');
          return;
        }
        if (newPass.length < 6) {
          alert('Password baru minimal 6 karakter.');
          return;
        }
        if (newPass !== confirmNewPass) {
          alert('Konfirmasi password baru tidak cocok.');
          return;
        }

        currentUser.password = newPass;
        localStorage.setItem('users', JSON.stringify(users));
        alert('Password berhasil diganti.');
        closeModal();
      });
    }

    // --- Call and Profile Simulation Modals ---
    function showCallModal(type) {
        const targetName = users.find(u => u.username === activeReceiver)?.name || activeReceiver;
        if (!activeReceiver) {
            alert('Pilih pengguna terlebih dahulu untuk melakukan panggilan.');
            return;
        }
        openModal(`Panggilan ${type === 'video' ? 'Video' : 'Suara'}`, `
            <p style="text-align: center; font-size: 1.2em; font-weight: 600;">
                <i class="fas fa-circle-notch fa-spin" style="margin-right: 10px; color: ${type === 'video' ? '#FF6B6B' : '#4FD1C5'};"></i> 
                Menghubungi ${targetName}...
            </p>
            <p style="text-align: center; font-size: 0.9em; color: #777;">(Fitur ini adalah simulasi. Panggilan sungguhan membutuhkan backend.)</p>
        `, 'Akhiri Panggilan', () => {
            alert(`Panggilan ${type === 'video' ? 'video' : 'suara'} dengan ${targetName} diakhiri.`);
            closeModal();
        });
        document.getElementById('modal-confirm-btn').classList.add('danger'); // Make button red for ending call
    }

    function showProfileModal() {
        if (!activeReceiver || activeReceiver === 'gemini') {
            alert('Pilih pengguna terlebih dahulu untuk melihat profil.');
            return;
        }
        const targetUser = users.find(u => u.username === activeReceiver);
        if (!targetUser) {
            alert('Pengguna tidak ditemukan.');
            return;
        }
        openModal(`Profil ${targetUser.name}`, `
            <p><b>Nama:</b> ${targetUser.name}</p>
            <p><b>Username:</b> ${targetUser.username}</p>
            <p><b>Role:</b> ${targetUser.role === 'admin' ? 'Administrator' : 'Pengguna Biasa'}</p>
            <p><b>Status:</b> ${targetUser.banned ? '<span style="color:red; font-weight:bold;">Dibanned</span>' : '<span style="color:green; font-weight:bold;">Aktif</span>'}</p>
            <hr style="margin: 15px 0; border: 0; border-top: 1px dashed #eee;">
            <p><b>Statistik Chat:</b></p>
            <ul>
                <li>Pesan Terkirim: ${targetUser.stats.chatsSent}</li>
                <li>Pesan Diterima: ${targetUser.stats.chatsReceived}</li>
            </ul>
        `, 'Tutup', null);
        document.getElementById('modal-confirm-btn').style.display = 'none'; // No confirm action for viewing profile
    }

    // --- Universal Modal Functions ---
    function openModal(title, bodyHtml, confirmText, onConfirm) {
      document.getElementById('modal-title').innerText = title;
      document.getElementById('modal-body').innerHTML = bodyHtml;
      const confirmBtn = document.getElementById('modal-confirm-btn');
      confirmBtn.innerText = confirmText;
      confirmBtn.onclick = onConfirm;
      document.getElementById('modal-backdrop').classList.add('show');
      confirmBtn.style.display = onConfirm ? 'block' : 'none'; // Show/hide confirm button based on if onConfirm is provided
      document.getElementById('modal-actions').style.justifyContent = onConfirm ? 'flex-end' : 'center'; // Adjust button alignment
      document.getElementById('modal-confirm-btn').classList.remove('danger'); // Reset button color
    }

    function closeModal() {
      document.getElementById('modal-backdrop').classList.remove('show');
      document.getElementById('modal-body').innerHTML = ''; // Clear modal body content
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
        refreshUserList(); // Ensure user list is populated initially for admin/user
    });

  </script>
</body>
</html>